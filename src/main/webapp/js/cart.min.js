$(function () {
    var addCart = false;
    $(document).on('click', 'button[data-toggle="add-cart"]', function () {
        var $btn = $(this);
        $('#form-shop').submit(function () {
            if ($('#fou').val() == 'abc') {
                alert("请先登录");
                return false;
            }
            var count = this.elements['count'].value;
            var $link = $('a[data-flag="link-cart"]');
            var $badge = $('<h1 class="cart-badge">' + count + '</h1>');
            $badge.hide();
            $badge.css({
                left: ($btn.offset().left + ($btn.outerWidth() - $badge.outerWidth()) / 2) + 'px',
                top: ($btn.offset().top - ($btn.outerHeight() - $badge.outerHeight()) / 2) + 'px'
            });
            $(document.body).after($badge);
            var x = $link.offset().left + 'px';
            var y = $link.offset().top + 'px';
            $badge.fadeIn('fast', function () {
                $badge.animate({left: x, top: y}, 'slow', function () {
                    $(this).fadeOut('fast', function () {
                        $(this).remove()
                    })
                })
            });
            $(this).unbind('submit');
            //异步提交
            var pid=$('#pid').val();
            var formData=new FormData();
            formData.append("pid",pid);
            formData.append("count",count);
            var url='/doCartAdd';
            $.ajax({
                url: url,
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function () {

                }
            });
            return false;
        })
    })
});

function toThousands(num) {
    var x = parseInt(num);
    var result = [], counter = 0;
    x = (x || 0).toString().split('');
    for (var i = x.length - 1; i >= 0; i -= 1) {
        counter += 1;
        result.unshift(x[i]);
        if (!(counter % 3) && i != 0) {
            result.unshift(',')
        }
    }
    var y = num.toString();
    var yIndex = -1;
    if ((yIndex = y.lastIndexOf('.')) != -1) {
        y = y.substring(yIndex)
    } else {
        y = ''
    }
    return result.join('') + y
}

$(function () {
    var parentChkecBoxChanged = function () {
        var checked = this.checked;
        $('input[name="subCheckbox"]').each(function (i, chk) {
            chk.checked = checked
        });
        calcSum()
    };
    var subChkecBoxChanged = function () {
        var chkecked = true;
        $('input[name="subCheckbox"]').each(function (i, chk) {
            if (!chk.checked) {
                chkecked = false
            }
        });
        $('input[name="parentCheckbox"]').get(0).checked = chkecked;
        calcSum()
    };
    var calcSum = function () {
        var sum = 0.0;
        $('input[name="subCheckbox"]').each(function (i, chk) {
            if (chk.checked) {
                var s = parseFloat($(chk).next('[type="hidden"]').val());
                sum += s
            }
        });
        $('#form-cart :submit').attr('disabled', !(sum && sum > 0));
        $('#sum').text('￥' + toThousands(sum.toFixed(2)));
        if (jQuery.Color) {
            $('#sum').stop().css({'backgroundColor': '#a66'}).animate({'backgroundColor': '#fff'}, 500);
        } else {
            $.getScript('js/jquery.color-2.1.2.min.js', function () {
                $('#sum').stop().css({'backgroundColor': '#a66'}).animate({'backgroundColor': '#fff'}, 500);
            })
        }
    };
    $(document).on('input', 'input[name="parentCheckbox"]', parentChkecBoxChanged);
    $(document).on('input', 'input[name="subCheckbox"]', subChkecBoxChanged);
    $('button[data-del]').unbind('click');
    $(document).on('click', 'button[data-del]',
        function () {
            if (confirm('确定删除购物车中商品？')) {
                window.location.href = "/cartDelete?id=" + $('#chk1').val();
                var $tr = $(this).parents('tr');
                $tr.fadeOut('fast', function () {
                    $(this).remove();
                    calcSum()
                })
            }
        })
});